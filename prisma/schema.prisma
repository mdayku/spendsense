generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  name         String
  email        String        @unique
  password     String?       // Hashed password for credentials auth
  role         UserRole      @default(USER)
  createdAt    DateTime      @default(now())
  accounts     Account[]
  amlLabels    AmlLabel[]
  consent      Consent?
  liabilities  Liability[]
  profiles     Profile[]
  reviewItems  ReviewItem[]
  transactions Transaction[]
  // NextAuth relations
  sessions     Session[]
  accountsAuth AccountAuth[]
}

model Consent {
  id        String        @id @default(cuid())
  userId    String        @unique
  status    ConsentStatus
  timestamp DateTime      @default(now())
  User      User          @relation(fields: [userId], references: [id])
}

model Account {
  id               String        @id @default(cuid())
  userId           String
  type             AccountType
  subtype          String
  numberMasked     String
  isoCurrencyCode  String
  balanceAvailable Float?
  balanceCurrent   Float
  creditLimit      Float?
  User             User          @relation(fields: [userId], references: [id])
  liabilities      Liability[]
  transactions     Transaction[]
}

model Transaction {
  id               String     @id @default(cuid())
  userId           String
  accountId        String
  date             DateTime
  amount           Float
  merchant         String?
  merchantEntityId String?
  paymentChannel   Channel
  pfcPrimary       PFCPrimary
  pfcDetailed      String?
  pending          Boolean    @default(false)
  Account          Account    @relation(fields: [accountId], references: [id])
  User             User       @relation(fields: [userId], references: [id])
}

model Liability {
  id           String        @id @default(cuid())
  userId       String
  accountId    String?
  type         LiabilityType
  aprType      String?
  aprPercent   Float?
  minPayment   Float?
  lastPayment  Float?
  isOverdue    Boolean?      @default(false)
  nextDueDate  DateTime?
  lastStmtBal  Float?
  interestRate Float?
  Account      Account?      @relation(fields: [accountId], references: [id])
  User         User          @relation(fields: [userId], references: [id])
}

model Profile {
  id                String       @id @default(cuid())
  userId            String
  windowDays        Int
  subscriptionCount Int
  monthlyRecurring  Float
  subscriptionShare Float
  netSavingsInflow  Float
  savingsGrowthRate Float
  emergencyMonths   Float
  utilMax           Float
  utilFlags         String
  minPayOnly        Boolean
  interestCharges   Boolean
  overdue           Boolean
  incomeMedianGap   Int
  cashBufferMonths  Float
  persona           String
  decisionTrace     String
  createdAt         DateTime     @default(now())
  User              User         @relation(fields: [userId], references: [id])
  reviewItems       ReviewItem[]
}

model ReviewItem {
  id        String       @id @default(cuid())
  userId    String
  profileId String
  status    ReviewStatus @default(pending)
  reason    String
  notes     String?
  decidedAt DateTime?
  createdAt DateTime     @default(now())
  Profile   Profile      @relation(fields: [profileId], references: [id])
  User      User         @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
  @@index([userId])
}

model AmlLabel {
  id           String    @id @default(cuid())
  userId       String
  extTxId      String?
  label        Boolean
  amount       Float?
  counterparty String?
  date         DateTime?
  createdAt    DateTime  @default(now())
  User         User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum ConsentStatus {
  OPTED_IN
  OPTED_OUT
}

enum AccountType {
  checking
  savings
  credit
  money_market
  hsa
}

enum Channel {
  online
  in_store
  atm
  other
}

enum PFCPrimary {
  income
  transfer
  subscription
  groceries
  dining
  bills
  entertainment
  travel
  other
}

enum LiabilityType {
  credit_card
  mortgage
  student_loan
}

enum ReviewStatus {
  pending
  approved
  overridden
}

enum UserRole {
  USER
  OPERATOR
}

// NextAuth tables
model AccountAuth {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
